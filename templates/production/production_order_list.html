{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>生产工单列表</h2>

    <!-- 检索框 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="searchOrder" class="form-control w-50" placeholder="搜索工单编号或销售订单编号或者按产线名称查询">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal" id="createOrderButton">
            <i class="fas fa-receipt"></i> 创建工单
        </button>
    </div>

   <!-- 生产工单表格 -->
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>工单编号</th>
                <th>销售订单编号</th>
                <th>产线</th>
                <th>计划开工时间</th>
                <th>计划完工时间</th>
                <th>负责人</th>
                <th>备注</th>  
                <th>状态</th>  
                <th>操作</th>
            </tr>
        </thead>
        
        <tbody id="orderTableBody">
            {% for order in orders %}
            <tr id="order-{{ order.pk }}">
                <td>{{ order.order_number }}</td>
                <td>{{ order.sales_order.order_number }}</td>
                <td>{{ order.production_line.name }}</td>
                <td>{{ order.planned_start_time|date:"Y-m-d" }}</td>
                <td>{{ order.planned_end_time|date:"Y-m-d" }}</td>
                <td>{{ order.responsible_person }}</td>
                <td>{{ order.remarks|default:"无备注" }}</td>  <!-- 显示备注，若无则显示“无备注” -->
                <td>{{ order.get_status_display }}</td>  <!-- 使用 get_status_display 获取状态的可读形式 -->
                <td>
                    <button class="btn btn-warning btn-sm edit-order" data-id="{{ order.pk }}" >编辑</button>
                    <button class="btn btn-danger btn-sm delete-order" data-id="{{ order.pk }}">删除</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center text-muted">暂无生产工单</td>  <!-- 更新合并的列数 -->
            </tr>
            {% endfor %}
        </tbody>
    </table>


    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">上一页</a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}">{{ num }}</a>
            </li>
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}">下一页</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- 创建/编辑工单模态框 -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">创建工单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm" action="/production/orders/create/" method="post"> <!-- 设置创建的 action -->
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="sales_order" class="form-label">销售订单</label>
                        <select class="form-select" name="sales_order" id="salesOrderSelect" required>
                            <option value="">选择销售订单</option>
                            {% for sales_order in sales_orders %}
                                <option value="{{ sales_order.id }}">{{ sales_order.order_number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="production_line" class="form-label">产线</label>
                        <select class="form-select" name="production_line" id="productionLineSelect" required>
                            <option value="">选择产线</option>
                            {% for line in production_lines %}
                                <option value="{{ line.id }}">{{ line.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="planned_start_time" class="form-label">计划开工时间</label>
                        <input type="date" class="form-control" name="planned_start_time" id="planned_start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="planned_end_time" class="form-label">计划完工时间</label>
                        <input type="date" class="form-control" name="planned_end_time" id="planned_end_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="remarks" class="form-label">备注</label>  <!-- 添加备注字段 -->
                        <textarea class="form-control" name="remarks" id="remarks" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-success" id="saveButton">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        //查找
        document.getElementById("searchOrder").addEventListener("input", function () {
            const query = this.value.toLowerCase();
            document.querySelectorAll("#orderTableBody tr").forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(query) ? "" : "none";
            });
        });

        // 监听创建工单按钮
        document.getElementById('createOrderButton').addEventListener('click', function() {
            document.getElementById('orderForm').reset(); // 重置表单
            document.getElementById('orderModalLabel').innerText = '创建工单'; // 设置为创建标题
            document.getElementById('orderForm').action = '/production/orders/create/'; // 设置 action 为创建接口
        });
        
        // 监听编辑按钮
        document.querySelectorAll('.edit-order').forEach(button => {
            button.addEventListener('click', function () {
                document.getElementById('orderModalLabel').innerText = '编辑工单'; // 设置为编辑标题
                const orderId = this.getAttribute('data-id'); // 获取工单 ID
        
                // 动态设置表单的 action URL，根据工单 ID 指向编辑接口
                const orderForm = document.getElementById('orderForm');
                orderForm.action = `/production/orders/edit/${orderId}/`; // 设置表单提交 URL
                
                // 使用 Fetch API 加载工单数据
                fetch(`/production/orders/view/${orderId}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('加载的工单数据:', data.order); // 调试日志
                        if (data.success) {
                            // 填充表单字段 
                            document.getElementById('salesOrderSelect').value = data.order.sales_order; // 销售订单 ID
                            document.getElementById('productionLineSelect').value = data.order.production_line; // 产线 ID
                            document.getElementById('planned_start_time').value = data.order.planned_start_time.split('T')[0]; // 计划开工时间
                            document.getElementById('planned_end_time').value = data.order.planned_end_time.split('T')[0]; // 计划完工时间
                            
                            // 填充备注字段
                            document.getElementById('remarks').value = data.order.remarks || ''; // 备注信息，默认为空
                            
                            // 显示模态框
                            new bootstrap.Modal(document.getElementById('orderModal')).show();
                        } else {
                            alert('加载失败: ' + (data.message || '未知错误'));
                        }
                    })
                    .catch(error => {
                        console.error('请求失败:', error);
                        alert('加载工单失败，请检查网络或联系管理员');
                    });
            });
        });

        // 监听表单提交事件
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const actionUrl = this.action; // 动态获取当前 form 的 action
            fetch(actionUrl, {
                method: "POST",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // 确保 CSRF 令牌被发送
                },
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if(data.warning) {
                            alert((actionUrl.includes("create") ? "工单创建成功！" : "工单编辑成功！") + JSON.stringify(data.warning));
                            location.reload(); // 刷新页面
                        }
                        else {
                            alert(actionUrl.includes("create") ? "工单创建成功！" : "工单编辑成功！");
                            location.reload(); // 刷新页面
                        }
                    } else {
                        alert((actionUrl.includes("create") ? "创建失败：" : "编辑失败：") + JSON.stringify(data.message));
                    }
                })
                .catch(error => {
                    alert("请求失败：" + error.message);
                });
        });

        document.querySelectorAll('.delete-order').forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-id');
                deleteOrder(orderId);
            });
        });

        function deleteOrder(orderId) {
            if (confirm('确定要删除该工单吗？')) {
                fetch(`/production/orders/delete/${orderId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message); // 使用返回的消息
                        document.getElementById(`order-${orderId}`).remove(); // 移除 DOM 中的条目
                        location.reload();
                    } else {
                        alert('删除失败，请重试：' + data.message);
                    }
                })
                .catch(error => {
                    alert('删除工单请求失败，请检查网络或联系管理员。');
                });
            }
        }
    });
</script>
{% endblock %}
